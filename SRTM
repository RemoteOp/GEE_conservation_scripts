var srtm = ee.Image("NASA/NASADEM_HGT/001").select('elevation');

var AOIVis = AOI.style({color: "FF4500" , width: 3, fillColor: "FFFFFF00"});

Map.addLayer(AOIVis, null, "AOI_IberianHigh");

Map.centerObject(AOI, 6);

var srtmVis = {
  min: 0,
  max: 3000,
  palette: ['blue', 'green', 'yellow', 'orange', 'red']
};

var srtm_AOI = srtm.clip(AOI)

Map.addLayer(srtm_AOI, srtmVis, 'AOI Elevation');


// HISTOGRAM
var histogram = ui.Chart.image.histogram({
  image: srtm_AOI,
  region: AOI,
  scale: 50   ,
  minBucketWidth: 50   
});
histogram.setOptions({
  title: 'Histogram of Elevation in Iberian Highland (meters)'
});

print(histogram);


// SPATIAL REDUCERS MEAN
var reducers_all = ee.Reducer.mean()
  .combine(ee.Reducer.min(), null, true)
  .combine(ee.Reducer.max(), null, true);

var AOI_stats = srtm_AOI.reduceRegions({
  collection: AOI,
  reducer: reducers_all,
  scale: 30  
});

// Removing empty rows
var AOI_stats_clean = AOI_stats.filter(ee.Filter.notNull(['mean']));

print("Clean_AOI_stat:", AOI_stats_clean);


// SPATIL REDUCERS PERCENTILES [50, 95]
var percentiles = ee.Reducer.percentile([50, 95]);

var AOI_percentiles = srtm_AOI.reduceRegions({
  collection: AOI,
  reducer: percentiles,
  scale: 30  
});

// Removing empty rows
var AOI_percentiles_clean = AOI_percentiles.filter(
  ee.Filter.notNull(['p50'])  
);

print("Clean_AOI_percentiles:", AOI_percentiles_clean);


//Export srtm Data
Export.image.toDrive({
  image: srtm_AOI,     
  description: 'NASADEM_Elevation_AOI',
  fileNamePrefix: 'NASADEM_Elevation_AOI',
  region: AOI,
  scale: 30,
  maxPixels: 1e13,
  fileFormat: 'GeoTIFF',
  formatOptions: {cloudOptimized: true}
});

Export.table.toDrive({
  collection: AOI_stats_clean,
  description: 'AOI stats elevation',
  fileFormat: 'CSV',
  selectors: ['mean', 'min', 'max']
});

Export.table.toDrive({
  collection: AOI_percentiles_clean,
  description: 'AOI percentiles elevation',
  fileFormat: 'CSV',
  selectors: ['p50', 'p95']
});
